package com.sefra

import android.content.Context
import android.os.Build
import android.os.Bundle
import android.provider.Settings
import android.util.Log
import android.view.View
import android.view.ViewGroup
import android.webkit.CookieManager
import android.webkit.ConsoleMessage
import android.webkit.JavascriptInterface
import android.webkit.WebChromeClient
import android.webkit.WebStorage
import android.webkit.WebView
import android.webkit.WebViewClient
import androidx.activity.compose.BackHandler
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.biometric.BiometricManager
import androidx.biometric.BiometricPrompt
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.foundation.layout.systemBarsPadding
import androidx.compose.runtime.Composable
import androidx.compose.runtime.DisposableEffect
import androidx.compose.runtime.getValue
import androidx.compose.runtime.mutableStateOf
import androidx.compose.runtime.remember
import androidx.compose.runtime.setValue
import androidx.compose.ui.Modifier
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.viewinterop.AndroidView
import androidx.core.content.ContextCompat
import androidx.fragment.app.FragmentActivity
import com.sefra.ui.theme.SefraTheme
import com.google.firebase.messaging.FirebaseMessaging
import java.io.File
import android.app.Dialog
import android.graphics.Color
import android.view.WindowManager
import androidx.core.view.ViewCompat
import androidx.core.view.WindowInsetsCompat
import android.content.Intent
import android.net.Uri
import android.content.ActivityNotFoundException
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import java.net.HttpURLConnection
import java.net.URL

class MainActivity : FragmentActivity() {
    var currentWebView: WebView? = null

    override fun onResume() {
        super.onResume()
        // ë‹¤ë¥¸ ì•±(ë³¸ì¸ì¸ì¦ ë“±)ì—ì„œ ëŒì•„ì™”ì„ ë•Œ WebView ìƒˆë¡œê³ ì¹¨ ë°©ì§€
        Log.d("MainActivity", "onResume called, WebView state preserved")
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // ìµœì´ˆ ì‹¤í–‰ì‹œì—ë§Œ WebView ë°ì´í„° ì •ë¦¬ (ë³¸ì¸ì¸ì¦ ë“±ì—ì„œ ëŒì•„ì˜¬ ë•ŒëŠ” ì„¸ì…˜ ìœ ì§€)
        if (savedInstanceState == null) {
            clearWebViewData()
            Log.d("MainActivity", "First launch - WebView data cleared")
        } else {
            Log.d("MainActivity", "Restored from saved state - WebView data preserved")
        }

        // Initialize FCM and request notification permission
        initializeFCM()

        // Edge-to-Edge í™œì„±í™” (ìƒíƒœë°” ì•„ë˜ë¶€í„° ì‹œì‘)
        enableEdgeToEdge()

        setContent {
            SefraTheme {
                WebViewScreen()
            }
        }

        // ìƒíƒœë°” ìƒ‰ìƒ ì„¤ì • (setContent í›„ì— í•´ì•¼ windowê°€ ì¤€ë¹„ë¨)
        try {
            window.statusBarColor = android.graphics.Color.WHITE
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
                window.insetsController?.setSystemBarsAppearance(
                    android.view.WindowInsetsController.APPEARANCE_LIGHT_STATUS_BARS,
                    android.view.WindowInsetsController.APPEARANCE_LIGHT_STATUS_BARS
                )
            } else if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
                @Suppress("DEPRECATION")
                window.decorView.systemUiVisibility = View.SYSTEM_UI_FLAG_LIGHT_STATUS_BAR
            }
        } catch (e: Exception) {
            Log.e("MainActivity", "Failed to set status bar color", e)
        }

        // Handle notification click
        handleNotificationIntent(intent)
    }

    override fun onNewIntent(intent: android.content.Intent?) {
        super.onNewIntent(intent)
        intent?.let { handleNotificationIntent(it) }
    }

    private fun handleNotificationIntent(intent: android.content.Intent) {
        val notificationType = intent.getStringExtra("notification_type")
        val targetUrl = intent.getStringExtra("target_url")

        if (notificationType != null && targetUrl != null && targetUrl.isNotEmpty()) {
            Log.d("MainActivity", "Notification clicked: type=$notificationType, url=$targetUrl")

            // Load target URL in WebView
            currentWebView?.loadUrl(targetUrl)
        }
    }

    private fun initializeFCM() {
        try {
            // Request notification permission for Android 13+
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                requestPermissions(arrayOf(android.Manifest.permission.POST_NOTIFICATIONS), 100)
            }

            // Get FCM token
            FirebaseMessaging.getInstance().token.addOnCompleteListener { task ->
                if (!task.isSuccessful) {
                    Log.w("MainActivity", "Fetching FCM token failed", task.exception)
                    return@addOnCompleteListener
                }

                val token = task.result
                Log.d("MainActivity", "FCM Token: $token")

                // Store token locally
                getSharedPreferences("sefra_prefs", Context.MODE_PRIVATE)
                    .edit()
                    .putString("fcm_token", token)
                    .apply()

                Log.d("MainActivity", "FCMí† í°ì €ì¥ë¨ : $token")
            }

            // Subscribe to general topic for broadcast notifications
            FirebaseMessaging.getInstance().subscribeToTopic("general")
                .addOnCompleteListener { task ->
                    val msg = if (task.isSuccessful) "Subscribed to general topic" else "Failed to subscribe"
                    Log.d("MainActivity", msg)
                }
        } catch (e: Exception) {
            Log.e("MainActivity", "FCM initialization failed - continuing without FCM", e)
        }
    }

    private fun clearWebViewData() {
        // ì„¸ì…˜ ìœ ì§€ë¥¼ ìœ„í•´ ì¿ í‚¤ì™€ ìŠ¤í† ë¦¬ì§€ëŠ” ì‚­ì œí•˜ì§€ ì•ŠìŒ
        // CookieManager.getInstance().apply {
        //     removeAllCookies(null)
        //     flush()
        // }

        // WebStorage.getInstance().deleteAllData()  // localStorageë„ ìœ ì§€

        try {
            cacheDir.deleteRecursively()
            applicationContext.cacheDir.deleteRecursively()

            val webViewDir = applicationContext.getDir("webview", Context.MODE_PRIVATE)
            deleteRecursive(webViewDir)

            val webViewCacheDir = File(applicationContext.cacheDir.absolutePath + "/webviewCache")
            if (webViewCacheDir.exists()) {
                deleteRecursive(webViewCacheDir)
            }
        } catch (e: Exception) {
            Log.e("MainActivity", "Failed to delete webview directory", e)
        }

        Log.d("MainActivity", "WebView data cleared on app start")
    }

    private fun deleteRecursive(fileOrDirectory: java.io.File) {
        if (fileOrDirectory.isDirectory) {
            fileOrDirectory.listFiles()?.forEach { child ->
                deleteRecursive(child)
            }
        }
        fileOrDirectory.delete()
    }

    fun getAndroidDeviceId(): String {
        return Settings.Secure.getString(contentResolver, Settings.Secure.ANDROID_ID)
    }

    inner class BiometricInterface {
        @JavascriptInterface
        fun getFCMToken(): String {
            return try {
                val token = getSharedPreferences("sefra_prefs", Context.MODE_PRIVATE)
                    .getString("fcm_token", "") ?: ""
                Log.d("BiometricInterface", "FCM Token requested: $token")
                token
            } catch (e: Exception) {
                Log.e("BiometricInterface", "Failed to get FCM token", e)
                ""
            }
        }

        @JavascriptInterface
        fun sendTokenToServer(token: String, serverUrl: String) {
            Log.d("BiometricInterface", "Sending FCM token to server: $serverUrl")

            CoroutineScope(Dispatchers.IO).launch {
                try {
                    val url = URL(serverUrl)
                    val connection = url.openConnection() as HttpURLConnection
                    connection.requestMethod = "POST"
                    connection.setRequestProperty("Content-Type", "application/json")
                    connection.doOutput = true

                    val deviceId = getAndroidDeviceId()
                    val jsonData = """{"fcm_token": "$token", "device_id": "$deviceId"}"""

                    connection.outputStream.use { os ->
                        os.write(jsonData.toByteArray())
                        os.flush()
                    }

                    val responseCode = connection.responseCode
                    Log.d("BiometricInterface", "Server response code: $responseCode")

                    if (responseCode == HttpURLConnection.HTTP_OK) {
                        val response = connection.inputStream.bufferedReader().readText()
                        Log.d("BiometricInterface", "Server response: $response")
                    }

                    connection.disconnect()
                } catch (e: Exception) {
                    Log.e("BiometricInterface", "Failed to send token to server", e)
                }
            }
        }

        @JavascriptInterface
        fun authenticate() {
            Log.d("BiometricAuth", "========================================")
            Log.d("BiometricAuth", "authenticate() called from JavaScript")
            Log.d("BiometricAuth", "========================================")

            runOnUiThread {
                val executor = ContextCompat.getMainExecutor(this@MainActivity)
                val biometricPrompt = BiometricPrompt(this@MainActivity, executor,
                    object : BiometricPrompt.AuthenticationCallback() {
                        override fun onAuthenticationError(errorCode: Int, errString: CharSequence) {
                            super.onAuthenticationError(errorCode, errString)
                            Log.e("BiometricAuth", "âŒ Authentication ERROR")
                            Log.e("BiometricAuth", "Error code: $errorCode")
                            Log.e("BiometricAuth", "Error message: $errString")

                            currentWebView?.evaluateJavascript(
                                "if(window.onBiometricResult) window.onBiometricResult(false, '$errString');",
                                null
                            )
                        }

                        override fun onAuthenticationSucceeded(result: BiometricPrompt.AuthenticationResult) {
                            super.onAuthenticationSucceeded(result)
                            Log.d("BiometricAuth", "âœ… Authentication SUCCEEDED!")
                            Log.d("BiometricAuth", "Building credential data...")

                            runOnUiThread {
                                try {
                                    val deviceId = getAndroidDeviceId()
                                    val timestamp = System.currentTimeMillis()

                                    Log.d("BiometricAuth", "Device ID: $deviceId")
                                    Log.d("BiometricAuth", "Timestamp: $timestamp")
                                    Log.d("BiometricAuth", "Fetching passkeyChallenge from window...")

                                    currentWebView?.evaluateJavascript("window.passkeyChallenge") { challengeResult ->
                                        Log.d("BiometricAuth", "Challenge result: $challengeResult")

                                        currentWebView?.evaluateJavascript("window.passkeyRpId") { rpIdResult ->
                                            Log.d("BiometricAuth", "RpId result: $rpIdResult")

                                            val challenge = challengeResult?.trim('"') ?: "android_biometric_challenge_$timestamp"
                                            val rpId = rpIdResult?.trim('"') ?: "sefra.kr"

                                            Log.d("BiometricAuth", "Using challenge: $challenge")
                                            Log.d("BiometricAuth", "Using rpId: $rpId")

                                            val credentialId = "android_biometric_$deviceId"
                                            val origin = "https://$rpId"

                                            Log.d("BiometricAuth", "Credential ID: $credentialId")
                                            Log.d("BiometricAuth", "Origin: $origin")

                                            val clientDataJSON = """{"type":"webauthn.create","challenge":"$challenge","origin":"$origin","crossOrigin":false,"android_biometric":true}"""
                                            val clientDataBase64 = android.util.Base64.encodeToString(clientDataJSON.toByteArray(), android.util.Base64.NO_WRAP or android.util.Base64.URL_SAFE or android.util.Base64.NO_PADDING)

                                            val attestationObject = "android_biometric_attestation"
                                            val attestationBase64 = android.util.Base64.encodeToString(attestationObject.toByteArray(), android.util.Base64.NO_WRAP or android.util.Base64.URL_SAFE or android.util.Base64.NO_PADDING)

                                            Log.d("BiometricAuth", "ClientDataJSON: $clientDataJSON")
                                            Log.d("BiometricAuth", "ClientData Base64: $clientDataBase64")
                                            Log.d("BiometricAuth", "Attestation Base64: $attestationBase64")

                                            val passkeyData = """
                                                {
                                                    "id": "$credentialId",
                                                    "type": "public-key",
                                                    "clientDataJSON": "$clientDataBase64",
                                                    "attestationObject": "$attestationBase64",
                                                    "transports": ["internal"],
                                                    "android_biometric": true,
                                                    "device_id": "$deviceId",
                                                    "timestamp": $timestamp
                                                }
                                            """.trimIndent()

                                            Log.d("BiometricAuth", "=== PasskeyData JSON START ===")
                                            Log.d("BiometricAuth", passkeyData)
                                            Log.d("BiometricAuth", "=== PasskeyData JSON END ===")

                                            val jsCode = "javascript:(function(){" +
                                                    "try{" +
                                                    "console.log('[BiometricAuth] JavaScript execution started');" +
                                                    "var d={" +
                                                    "id:'$credentialId'," +
                                                    "type:'public-key'," +
                                                    "clientDataJSON:'$clientDataBase64'," +
                                                    "attestationObject:'$attestationBase64'," +
                                                    "transports:['internal']," +
                                                    "android_biometric:true," +
                                                    "device_id:'$deviceId'," +
                                                    "timestamp:$timestamp" +
                                                    "};" +
                                                    "console.log('[BiometricAuth] PasskeyData object created:',JSON.stringify(d));" +
                                                    "if(window.onBiometricResult){" +
                                                    "console.log('[BiometricAuth] Calling onBiometricResult...');" +
                                                    "window.onBiometricResult(true,'Success',d);" +
                                                    "console.log('[BiometricAuth] onBiometricResult called OK');" +
                                                    "}else{" +
                                                    "console.log('[BiometricAuth] âš ï¸ window.onBiometricResult NOT FOUND');" +
                                                    "}" +
                                                    "var regData={id:'$credentialId',rawId:'${android.util.Base64.encodeToString(credentialId.toByteArray(), android.util.Base64.URL_SAFE or android.util.Base64.NO_WRAP or android.util.Base64.NO_PADDING)}',type:'public-key',response:{clientDataJSON:'$clientDataBase64',attestationObject:'$attestationBase64'}};" +
                                                    "console.log('[BiometricAuth] RegData created:',JSON.stringify(regData));" +
                                                    "if(window.onPasskeyRegistered){" +
                                                    "console.log('[BiometricAuth] Calling onPasskeyRegistered...');" +
                                                    "window.onPasskeyRegistered(JSON.stringify(regData));" +
                                                    "console.log('[BiometricAuth] onPasskeyRegistered called OK');" +
                                                    "}else{" +
                                                    "console.log('[BiometricAuth] â„¹ï¸ window.onPasskeyRegistered NOT FOUND (might be login, not registration)');" +
                                                    "}" +
                                                    "if(window.onBiometricLoginSuccess){" +
                                                    "console.log('[BiometricAuth] Calling onBiometricLoginSuccess...');" +
                                                    "console.log('[BiometricAuth] Sending data to onBiometricLoginSuccess:',JSON.stringify(d));" +
                                                    "window.onBiometricLoginSuccess(d);" +
                                                    "console.log('[BiometricAuth] âœ… onBiometricLoginSuccess called OK');" +
                                                    "}else{" +
                                                    "console.log('[BiometricAuth] âš ï¸ window.onBiometricLoginSuccess NOT FOUND');" +
                                                    "}" +
                                                    "console.log('[BiometricAuth] JavaScript execution finished');" +
                                                    "}catch(e){" +
                                                    "console.error('[BiometricAuth] âŒ JavaScript Error:',e);" +
                                                    "console.error('[BiometricAuth] Error stack:',e.stack);" +
                                                    "alert('BiometricAuth JS Error: '+e.message);" +
                                                    "}" +
                                                    "})();"

                                            Log.d("BiometricAuth", "=== JavaScript Code START ===")
                                            Log.d("BiometricAuth", jsCode)
                                            Log.d("BiometricAuth", "=== JavaScript Code END ===")
                                            Log.d("BiometricAuth", "Executing JavaScript now...")

                                            currentWebView?.loadUrl(jsCode)

                                            Log.d("BiometricAuth", "âœ… JavaScript executed via loadUrl()")
                                            Log.d("BiometricAuth", "Check WebView console logs for callback execution")
                                        }
                                    }
                                } catch (e: Exception) {
                                    Log.e("BiometricAuth", "âŒ EXCEPTION in onAuthenticationSucceeded", e)
                                    Log.e("BiometricAuth", "Exception message: ${e.message}")
                                    Log.e("BiometricAuth", "Exception stack trace:")
                                    e.printStackTrace()
                                }
                            }
                        }

                        override fun onAuthenticationFailed() {
                            super.onAuthenticationFailed()
                            Log.w("BiometricAuth", "âš ï¸ Authentication FAILED (retry possible)")
                        }
                    })

                val promptInfo = BiometricPrompt.PromptInfo.Builder()
                    .setTitle("íŒ¨ìŠ¤í‚¤ ì¸ì¦")
                    .setSubtitle("ì§€ë¬¸ ë˜ëŠ” ì–¼êµ´ ì¸ì‹ìœ¼ë¡œ ì¸ì¦í•˜ì„¸ìš”")
                    .setNegativeButtonText("ì·¨ì†Œ")
                    .build()

                Log.d("BiometricAuth", "Showing biometric prompt...")
                biometricPrompt.authenticate(promptInfo)
                Log.d("BiometricAuth", "Biometric prompt displayed, waiting for user...")
            }
        }

        @JavascriptInterface
        fun isAvailable(): Boolean {
            val biometricManager = BiometricManager.from(this@MainActivity)
            return biometricManager.canAuthenticate(BiometricManager.Authenticators.BIOMETRIC_WEAK) == BiometricManager.BIOMETRIC_SUCCESS
        }
    }
}

@Composable
fun WebViewScreen() {
    val context = LocalContext.current
    val activity = context as? MainActivity
    var webView: WebView? by remember { mutableStateOf(null) }

    val deviceId = remember {
        activity?.getAndroidDeviceId() ?: ""
    }

    BackHandler(enabled = true) {
        if (webView?.canGoBack() == true) {
            webView?.goBack()
        } else {
            activity?.finish()
        }
    }

    DisposableEffect(Unit) {
        onDispose {
            webView?.let {
                it.clearCache(true)
                it.clearHistory()
                it.clearFormData()
                Log.d("WebViewScreen", "WebView cache and history cleared")
            }
        }
    }

    AndroidView(
        modifier = Modifier
            .fillMaxSize()
            .systemBarsPadding(),
        factory = { context ->
            WebView(context).also {
                webView = it
                activity?.currentWebView = it
            }.apply {
                layoutParams = ViewGroup.LayoutParams(
                    ViewGroup.LayoutParams.MATCH_PARENT,
                    ViewGroup.LayoutParams.MATCH_PARENT
                )

                WebView.setWebContentsDebuggingEnabled(true)

                // ì¿ í‚¤ í—ˆìš© (ì„¸ì…˜ ìœ ì§€ë¥¼ ìœ„í•´)
                val cookieManager = CookieManager.getInstance()
                cookieManager.setAcceptCookie(true)
                cookieManager.setAcceptThirdPartyCookies(this, true)

                activity?.let {
                    addJavascriptInterface(it.BiometricInterface(), "AndroidBiometric")
                }

                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                    importantForAutofill = View.IMPORTANT_FOR_AUTOFILL_NO_EXCLUDE_DESCENDANTS
                }

                settings.apply {
                    javaScriptEnabled = true
                    domStorageEnabled = true
                    databaseEnabled = true
                    loadWithOverviewMode = true
                    useWideViewPort = true
                    setSupportZoom(true)
                    builtInZoomControls = true
                    displayZoomControls = false
                    saveFormData = false
                    allowFileAccess = false
                    allowContentAccess = false
                    // cacheMode = android.webkit.WebSettings.LOAD_NO_CACHE  // ì„¸ì…˜ ìœ ì§€ë¥¼ ìœ„í•´ ì£¼ì„ì²˜ë¦¬
                    cacheMode = android.webkit.WebSettings.LOAD_DEFAULT  // ê¸°ë³¸ ìºì‹œ ëª¨ë“œ ì‚¬ìš©

                    // íŒì—… ë° ìƒˆ ì°½ ì§€ì›
                    javaScriptCanOpenWindowsAutomatically = true
                    setSupportMultipleWindows(true)

                    userAgentString = "Mozilla/5.0 (Linux; Android ${Build.VERSION.RELEASE}; ${Build.MODEL}) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36 Sefra/1.0"
                }

                webChromeClient = object : WebChromeClient() {
                    override fun onConsoleMessage(consoleMessage: ConsoleMessage?): Boolean {
                        val msg = consoleMessage?.message() ?: ""
                        val source = consoleMessage?.sourceId() ?: ""
                        val line = consoleMessage?.lineNumber() ?: 0

                        // íŠ¹ë³„íˆ BiometricAuth ê´€ë ¨ ë¡œê·¸ëŠ” ê°•ì¡° í‘œì‹œ
                        if (msg.contains("[BiometricAuth]") || msg.contains("onBiometricLoginSuccess")) {
                            Log.i("WebView-JS", "ğŸ” $msg [$source:$line]")
                        } else {
                            Log.d("WebView-JS", "$msg [$source:$line]")
                        }
                        return true
                    }

                    // ìƒˆ ì°½ ì—´ê¸° ì²˜ë¦¬ (íŒì—…, ë³¸ì¸ì¸ì¦ ë“±)
                    override fun onCreateWindow(
                        view: WebView?,
                        isDialog: Boolean,
                        isUserGesture: Boolean,
                        resultMsg: android.os.Message?
                    ): Boolean {
                        val newWebView = WebView(activity ?: context)
                        newWebView.settings.apply {
                            javaScriptEnabled = true
                            javaScriptCanOpenWindowsAutomatically = true
                            setSupportMultipleWindows(true)
                            domStorageEnabled = true
                        }

                        // Dialog ìƒì„±
                        val dialog = Dialog(activity ?: context, android.R.style.Theme_Black_NoTitleBar_Fullscreen)
                        dialog.setContentView(newWebView)

                        // ìƒíƒœë°” íˆ¬ëª…í•˜ê²Œ ì„¤ì •
                        dialog.window?.apply {
                            setFlags(
                                WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS,
                                WindowManager.LayoutParams.FLAG_LAYOUT_NO_LIMITS
                            )
                        }

                        newWebView.webViewClient = object : WebViewClient() {
                            override fun shouldOverrideUrlLoading(view: WebView?, request: android.webkit.WebResourceRequest?): Boolean {
                                val url = request?.url.toString()
                                Log.d("WebView", "Popup loading: $url")

                                return when {
                                    // intent:// scheme ì²˜ë¦¬ (ë³¸ì¸ì¸ì¦ ë“±)
                                    url.startsWith("intent://") -> {
                                        try {
                                            val intent = Intent.parseUri(url, Intent.URI_INTENT_SCHEME)

                                            activity?.let { act ->
                                                try {
                                                    act.startActivity(intent)
                                                    Log.d("WebView", "Intent launched from popup: $url")
                                                } catch (e: ActivityNotFoundException) {
                                                    // ì•±ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì€ ê²½ìš°
                                                    val fallbackUrl = intent.getStringExtra("browser_fallback_url")
                                                    val packageName = intent.getPackage()

                                                    when {
                                                        // fallback URLì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ë¡œë“œ
                                                        !fallbackUrl.isNullOrEmpty() -> {
                                                            view?.loadUrl(fallbackUrl)
                                                            Log.d("WebView", "Loading fallback URL from popup: $fallbackUrl")
                                                        }
                                                        // íŒ¨í‚¤ì§€ëª…ì´ ìˆìœ¼ë©´ ë§ˆì¼“ìœ¼ë¡œ ì´ë™
                                                        !packageName.isNullOrEmpty() -> {
                                                            val marketIntent = Intent(Intent.ACTION_VIEW)
                                                            marketIntent.data = Uri.parse("market://details?id=$packageName")
                                                            try {
                                                                act.startActivity(marketIntent)
                                                                Log.d("WebView", "Market opened from popup: $packageName")
                                                            } catch (e2: Exception) {
                                                                Log.e("WebView", "Failed to open market from popup", e2)
                                                            }
                                                        }
                                                        else -> {
                                                            Log.e("WebView", "No app to handle intent from popup and no fallback", e)
                                                        }
                                                    }
                                                }
                                            }
                                            true
                                        } catch (e: Exception) {
                                            Log.e("WebView", "Failed to parse intent from popup: $url", e)
                                            false
                                        }
                                    }
                                    // ì¼ë°˜ http/https URL
                                    url.startsWith("http://") || url.startsWith("https://") -> {
                                        view?.loadUrl(url)
                                        false
                                    }
                                    // ê¸°íƒ€ custom scheme
                                    else -> {
                                        try {
                                            val intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
                                            activity?.startActivity(intent)
                                            Log.d("WebView", "External scheme from popup: $url")
                                            true
                                        } catch (e: ActivityNotFoundException) {
                                            Log.e("WebView", "No app to handle from popup: $url", e)
                                            false
                                        }
                                    }
                                }
                            }
                        }

                        newWebView.webChromeClient = object : WebChromeClient() {
                            override fun onCloseWindow(window: WebView?) {
                                Log.d("WebView", "Popup window closed")
                                dialog.dismiss()
                            }
                        }

                        dialog.setOnDismissListener {
                            newWebView.destroy()
                        }

                        val transport = resultMsg?.obj as? android.webkit.WebView.WebViewTransport
                        transport?.webView = newWebView
                        resultMsg?.sendToTarget()

                        dialog.show()
                        Log.d("WebView", "Popup dialog shown")
                        return true
                    }
                }

                webViewClient = object : WebViewClient() {
                    override fun shouldOverrideUrlLoading(view: WebView?, request: android.webkit.WebResourceRequest?): Boolean {
                        val url = request?.url.toString()

                        return when {
                            // intent:// scheme ì²˜ë¦¬ (ë³¸ì¸ì¸ì¦ ë“±)
                            url.startsWith("intent://") -> {
                                try {
                                    val intent = Intent.parseUri(url, Intent.URI_INTENT_SCHEME)

                                    activity?.let { act ->
                                        try {
                                            act.startActivity(intent)
                                            Log.d("WebView", "Intent launched: $url")
                                        } catch (e: ActivityNotFoundException) {
                                            // ì•±ì´ ì„¤ì¹˜ë˜ì§€ ì•Šì€ ê²½ìš°
                                            val fallbackUrl = intent.getStringExtra("browser_fallback_url")
                                            val packageName = intent.getPackage()

                                            when {
                                                // fallback URLì´ ìˆìœ¼ë©´ ê·¸ê²ƒì„ ë¡œë“œ
                                                !fallbackUrl.isNullOrEmpty() -> {
                                                    view?.loadUrl(fallbackUrl)
                                                    Log.d("WebView", "Loading fallback URL: $fallbackUrl")
                                                }
                                                // íŒ¨í‚¤ì§€ëª…ì´ ìˆìœ¼ë©´ ë§ˆì¼“ìœ¼ë¡œ ì´ë™
                                                !packageName.isNullOrEmpty() -> {
                                                    val marketIntent = Intent(Intent.ACTION_VIEW)
                                                    marketIntent.data = Uri.parse("market://details?id=$packageName")
                                                    try {
                                                        act.startActivity(marketIntent)
                                                        Log.d("WebView", "Market opened for: $packageName")
                                                    } catch (e2: Exception) {
                                                        Log.e("WebView", "Failed to open market", e2)
                                                    }
                                                }
                                                else -> {
                                                    Log.e("WebView", "No app to handle intent and no fallback", e)
                                                }
                                            }
                                        }
                                    }
                                    true
                                } catch (e: Exception) {
                                    Log.e("WebView", "Failed to parse intent: $url", e)
                                    false
                                }
                            }
                            // ì¼ë°˜ http/https URL
                            url.startsWith("http://") || url.startsWith("https://") -> {
                                view?.loadUrl(url)
                                false
                            }
                            // ê¸°íƒ€ custom scheme (ì „í™”, SMS ë“±)
                            else -> {
                                try {
                                    val intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
                                    activity?.startActivity(intent)
                                    Log.d("WebView", "External scheme launched: $url")
                                    true
                                } catch (e: ActivityNotFoundException) {
                                    Log.e("WebView", "No app to handle: $url", e)
                                    false
                                }
                            }
                        }
                    }

                    override fun onPageFinished(view: WebView?, url: String?) {
                        super.onPageFinished(view, url)
                        Log.d("WebView-Navigation", "ğŸ“„ Page loaded: $url")

                        view?.evaluateJavascript("""
                            (function() {
                                // ìë™ì™„ì„± ë¹„í™œì„±í™”
                                var inputs = document.querySelectorAll('input, textarea');
                                inputs.forEach(function(input) {
                                    input.setAttribute('autocomplete', 'off');
                                });

                                // PublicKeyCredential polyfill for Android WebView
                                if (typeof AndroidBiometric !== 'undefined' && AndroidBiometric.isAvailable()) {
                                    if (typeof window.PublicKeyCredential === 'undefined') {
                                        window.PublicKeyCredential = function() {};
                                        console.log('PublicKeyCredential polyfill injected');
                                    }
                                }

                                // ìƒì²´ì¸ì¦ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
                                var biometricAvailable = typeof AndroidBiometric !== 'undefined' && AndroidBiometric.isAvailable();
                                console.log('Native biometric available: ' + biometricAvailable);

                                // FCM í† í°ì„ ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ë¡œê·¸ì¸ í›„ ì›¹ì—ì„œ í˜¸ì¶œ)
                                window.sendFCMTokenToServer = function() {
                                    if (typeof AndroidBiometric !== 'undefined') {
                                        try {
                                            var fcmToken = AndroidBiometric.getFCMToken();
                                            if (fcmToken && fcmToken.length > 0) {
                                                console.log('FCM Token available:', fcmToken.substring(0, 30) + '...');

                                                if (typeof onB4xDataUpdated === 'function') {
                                                    onB4xDataUpdated({ fcmToken: fcmToken });
                                                    console.log('âœ… onB4xDataUpdated í•¨ìˆ˜ í˜¸ì¶œë¨ (fcmToken ì „ë‹¬)');
                                                    return true;
                                                } else {
                                                    console.warn('âš ï¸ onB4xDataUpdated í•¨ìˆ˜ê°€ ì •ì˜ë˜ì§€ ì•ŠìŒ');
                                                    return false;
                                                }
                                            } else {
                                                console.warn('âš ï¸ FCM í† í°ì´ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ');
                                                return false;
                                            }
                                        } catch (e) {
                                            console.error('âŒ FCM í† í° ì²˜ë¦¬ ì‹¤íŒ¨:', e);
                                            return false;
                                        }
                                    } else {
                                        console.error('âŒ AndroidBiometricì´ ì •ì˜ë˜ì§€ ì•ŠìŒ');
                                        return false;
                                    }
                                };

                                // FCM í† í° ì¦‰ì‹œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” í•¨ìˆ˜ë„ ì œê³µ
                                window.getFCMToken = function() {
                                    if (typeof AndroidBiometric !== 'undefined') {
                                        return AndroidBiometric.getFCMToken();
                                    }
                                    return '';
                                };

                                console.log('âœ… FCM í•¨ìˆ˜ ì¤€ë¹„ë¨: window.sendFCMTokenToServer(), window.getFCMToken()');

                                // onB4xDataUpdated í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ìë™ ì „ì†¡
                                if (typeof onB4xDataUpdated === 'function') {
                                    console.log('âœ… onB4xDataUpdated í•¨ìˆ˜ ë°œê²¬ë¨');
                                    // í˜ì´ì§€ ë¡œë“œ í›„ 1ì´ˆ ë’¤ FCM í† í° ì „ì†¡
                                    setTimeout(function() {
                                        console.log('ğŸ”„ FCM í† í° ìë™ ì „ì†¡ ì‹œë„...');
                                        var result = window.sendFCMTokenToServer();
                                        if (result) {
                                            console.log('âœ… FCM í† í° ìë™ ì „ì†¡ ì„±ê³µ');
                                        } else {
                                            console.log('âŒ FCM í† í° ìë™ ì „ì†¡ ì‹¤íŒ¨');
                                        }
                                    }, 1000);
                                } else {
                                    console.log('âš ï¸ onB4xDataUpdated í•¨ìˆ˜ê°€ ì•„ì§ ì •ì˜ë˜ì§€ ì•ŠìŒ (ë¡œê·¸ì¸ í›„ ì‚¬ìš© ê°€ëŠ¥í•  ìˆ˜ ìˆìŒ)');
                                }
                            })();
                        """.trimIndent(), null)
                    }
                }

                val urlWithDevice = "https://sefra.kr?device=$deviceId"
                Log.d("WebViewScreen", "Loading URL: $urlWithDevice")
                loadUrl(urlWithDevice)
            }
        }
    )
}
