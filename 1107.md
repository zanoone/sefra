# 2025년 11월 7일 - Sefra Flutter 크래시 디버깅 계속

**Date**: 2025-11-07
**Previous**: 1106.md
**Status**: 🔍 Firebase가 원인이 아님 확인됨

---

## 📝 중요 정보 (자동 기억)

### Git 정보
```bash
# 저장소
https://github.com/zanoone/sefra.git

# 브랜치
main

# 토큰 (항상 사용)
ghp_[MASKED_TOKEN]

# Push 명령어
git push https://ghp_[MASKED_TOKEN]@github.com/zanoone/sefra.git main
```

### "check" 명령어
```
사용자가 "check"를 입력하면:
1. http://121.155.14.128/d.txt를 자동으로 읽어옴
2. 내용을 이 파일(1107.md)에 업데이트
3. Git 토큰 정보는 항상 위의 값 사용
```

---

## 🔥 긴급 상황: v1.0.0+22에서도 크래시 발생!

### TestFlight Feedback #2 결과

**버전**: 1.0.0 (22) - Firebase 완전 제거 버전
**시간**: 2025-11-06 23:33:30 (KST)
**디바이스**: iPhone 13 (iPhone14,7)
**결과**: ❌ **여전히 크래시 발생**

```
Exception Type: EXC_BAD_ACCESS (SIGSEGV)
Exception Subtype: KERN_INVALID_ADDRESS at 0x0000000000000000

Thread 0 Crashed:
0   libswiftCore.dylib     swift_getObjectType + 40
1   Runner                 0x0000000100ae3d2c (offset 1244460)
```

### 💡 결론

**Firebase는 크래시 원인이 아닙니다!**

Firebase를 완전히 제거했는데도 동일한 위치에서 크래시가 발생했습니다.

---

## 📊 테스트 버전 히스토리

| 버전 | 변경사항 | 크래시 여부 | 결과 |
|------|---------|-----------|------|
| 1.0.0+18 | 원본 (Firebase 포함) | ❌ 크래시 | `swift_getObjectType + 40` |
| 1.0.0+19 | firebase_options.dart 추가 | ❌ 크래시 | 동일 위치 |
| 1.0.0+20 | 백그라운드 핸들러 제거 | ❌ 크래시 | 동일 위치 |
| 1.0.0+21 | 네이티브 Firebase 초기화 | ❌ 크래시 | 동일 위치 |
| **1.0.0+22** | **Firebase 완전 제거** | **❌ 크래시** | **동일 위치!** |

**공통 패턴**:
- 모든 버전에서 동일한 위치 크래시
- `swift_getObjectType`에서 null 포인터 (0x0000000000000000) 접근
- UIApplication 델리게이트 초기화 중 발생
- Release 빌드에서만 발생 (Debug/Simulator는 정상)

---

## 🎯 다음 조사 대상: 다른 플러그인

### 현재 사용 중인 플러그인

```yaml
dependencies:
  flutter_inappwebview: 6.0.0      # WebView (복잡한 네이티브 브릿지)
  local_auth: ^2.1.0               # 생체인증 (Face ID/Touch ID)
  device_info_plus: ^9.1.0         # 디바이스 정보
  shared_preferences: ^2.2.0       # 로컬 저장소
```

### 의심 순위

1. 🔴 **flutter_inappwebview** (최우선 의심)
   - 가장 복잡한 플러그인
   - 많은 네이티브 코드와 Swift 브릿지
   - Release 빌드에서 문제 발생 가능성 높음
   - 버전 6.0.0으로 고정 (이전에 6.1.5에서 다운그레이드)

2. 🟡 **local_auth** (중간 의심)
   - iOS 네이티브 API 사용 (생체인증)
   - 권한 및 설정 관련 이슈 가능
   - Release 빌드에서 초기화 문제 가능성

3. 🟢 **device_info_plus** (낮음)
   - 비교적 단순한 플러그인
   - 디바이스 ID 조회만 수행

4. 🟢 **shared_preferences** (매우 낮음)
   - 매우 단순하고 안정적
   - 크래시 가능성 거의 없음

---

## 🔬 다음 테스트 전략

### 옵션 1: flutter_inappwebview 제거 (추천)

**이유**:
- 가장 복잡한 플러그인
- 네이티브 브릿지 많음
- Release/Debug 차이에 민감

**변경사항**:
```yaml
# pubspec.yaml
# flutter_inappwebview: 6.0.0  # DISABLED FOR TESTING
```

**lib/main.dart**:
- InAppWebView를 일반 Container나 Text로 대체
- WebView 없이 기본 화면만 표시

**예상 결과**:
- ✅ 크래시 없음 → flutter_inappwebview가 원인
- ❌ 여전히 크래시 → 다른 플러그인 조사

### 옵션 2: 모든 플러그인 제거

**변경사항**:
- 모든 플러그인 주석 처리
- 기본 "Hello World" 앱만 실행

**목적**:
- 플러그인 vs 앱 구조 문제 구분

### 옵션 3: local_auth 제거

**변경사항**:
- local_auth 제거
- 생체인증 기능 비활성화

**목적**:
- 권한/생체인증이 문제인지 확인

---

## 🤔 추가 조사 방향

### 1. Release 빌드 설정 확인

**Xcode Build Settings**:
```
Optimization Level (Release): -Os
Dead Code Stripping: YES
Strip Debug Symbols: YES
```

Release 빌드가 Debug와 다른 최적화를 하기 때문에 문제 발생 가능.

### 2. Swift Concurrency 설정

**ios/Podfile**:
```ruby
config.build_settings['SWIFT_STRICT_CONCURRENCY'] = 'minimal'
```

이미 설정되어 있지만, 'complete'로 변경해볼 수 있음.

### 3. 메모리 관리

**가능성**:
- Release 빌드에서 ARC가 객체를 너무 빨리 해제
- 초기화되지 않은 변수 접근
- Weak/Strong reference 문제

---

## 📋 다음 작업 (v1.0.0+23)

### 추천: flutter_inappwebview 제거 테스트

**작업 순서**:
1. ✅ pubspec.yaml에서 flutter_inappwebview 주석 처리
2. ✅ lib/main.dart에서 InAppWebView 제거, 기본 UI로 대체
3. ✅ 버전 1.0.0+23으로 업데이트
4. ✅ flutter clean && flutter pub get
5. ✅ Pod 재설치
6. ✅ iOS Release 빌드
7. ✅ Git 커밋 & 푸시
8. ⏳ Codemagic 빌드 & TestFlight 배포
9. ⏳ 실제 기기 테스트

**예상 시간**: 30-40분

---

## 📎 관련 파일

- `1106.md` - 어제 전체 작업 기록 (933줄)
- `CRASH_DEBUG.md` - 크래시 분석 문서
- TestFlight 피드백:
  - `testflight_feedback.zip` - v1.0.0+21
  - `testflight_feedback-2.zip` - v1.0.0+22

---

## 🔄 업데이트 로그

### 2025-11-07 (최신) - 🔥 핵심 문제 발견! 로컬 vs Codemagic 차이

**서버 체크 (check 명령어)**:
```
sefra.kr 은 번들 아이디고
저거 왜 팅기냐고 시발련아
로컬로 빌드하면 시뮬레이터 잘돌아가는데
codemagic만돌아가면 실제 ios에서 에러난다고
```

### 🎯 핵심 발견

**✅ 로컬 빌드 + 시뮬레이터**: 정상 작동
**❌ Codemagic 빌드 + 실제 iOS 디바이스**: 크래시 발생

**이것은 빌드 환경 차이 문제입니다!**

### 🔍 가능한 원인

1. **Optimization Level 차이**
   - Codemagic이 더 공격적인 최적화 사용 가능
   - Release 빌드의 Swift 최적화 설정 차이

2. **Flutter/Xcode 버전 차이**
   - 로컬: (확인 필요)
   - Codemagic: Xcode `latest`, Flutter `stable`, M1 mac_mini

3. **빌드 플래그 차이**
   - Codemagic의 `codemagic.yaml` 설정
   - 추가 빌드 옵션이 문제 유발 가능

4. **코드 서명 관련**
   - 실제 디바이스 배포 시에만 발생
   - 시뮬레이터와 다른 바이너리 생성

5. **아키텍처 차이**
   - 시뮬레이터: x86_64
   - 실제 디바이스: arm64
   - arm64에서만 발생하는 메모리 정렬 문제 가능

### 🚨 Codemagic.yaml 분석 결과

**중요 발견: 빌드 명령이 없습니다!**

```yaml
scripts:
  - flutter clean
  - flutter packages pub get
  - flutter analyze  ← 분석만 하고 빌드 안 함!

artifacts:
  - build/ios/iphoneos/*.app  ← 빌드 안 했는데 결과만 찾으려 함
```

**Codemagic 환경:**
- Instance: `mac_mini_m1` (Apple Silicon)
- Xcode: `latest` (자동 업데이트)
- Flutter: `stable`
- 자동 코드 서명 및 TestFlight 제출

**해결: 명시적 빌드 명령 추가 완료 ✅**

### ✅ v1.0.0+24 배포 준비 중 (Xcode 직접 빌드)

**서버 체크 (check 명령어)**:
```
근데 꼭 flutter로 빌드해서 업로드해야해? codemagic 연동이긴한데
ios 로컬로 지금 xcode로는 빌드가 되는데 codemagic에서 빌드하고나서 실제 ios에서 실행하면
충돌뜨잖아 ios 시뮬레이터는 잘 작동되는데 ㅇㅇ..
```

**답변: Flutter 대신 Xcode 직접 빌드로 변경!**

**v1.0.0+24 변경사항**:
```yaml
# codemagic.yaml - Xcode 직접 빌드
- name: Build iOS release with Xcode (skip Flutter build)
  script: |
    cd ios
    xcodebuild archive \
      -workspace Runner.xcworkspace \
      -scheme Runner \
      -configuration Release \
      -archivePath $CM_BUILD_DIR/build/ios/Runner.xcarchive

    xcodebuild -exportArchive \
      -archivePath $CM_BUILD_DIR/build/ios/Runner.xcarchive \
      -exportPath $CM_BUILD_DIR/build/ios/ipa \
      -exportOptionsPlist $CM_BUILD_DIR/ios/exportOptions.plist
```

**추가한 파일**:
- `ios/exportOptions.plist` (App Store 배포용)

**전략 변경**:
- ❌ `flutter build ipa` (Flutter가 최적화하면서 문제 발생 가능)
- ✅ `xcodebuild` 직접 사용 (로컬 Xcode와 동일한 방식)

**Git 커밋 & 푸시**:
- ✅ 커밋: f22d448
- ✅ GitHub 푸시 완료
- ✅ Codemagic가 Xcode 빌드로 재시도할 것

**다음 단계**:
1. ⏳ Codemagic 빌드 대기 (xcodebuild 사용)
2. ⏳ TestFlight 자동 업로드
3. ⏳ 실제 디바이스에서 v1.0.0+24 테스트
4. 🤞 로컬 Xcode 방식과 동일하므로 성공 기대!

### ✅ v1.0.0+23 배포 완료 (Flutter build - 실패 가능성)

**변경사항**:
```yaml
# codemagic.yaml
- name: Build iOS release
  script: |
    flutter build ipa --release

artifacts:
  - build/ios/ipa/*.ipa  # .app → .ipa로 변경
```

**Git 커밋 & 푸시**:
- ✅ 커밋: 0e35c89
- ✅ GitHub 푸시 완료
- ✅ Codemagic가 자동으로 빌드 시작할 것

**다음 단계**:
1. ⏳ Codemagic 빌드 대기 (자동 트리거)
2. ⏳ TestFlight 자동 업로드
3. ⏳ 실제 디바이스에서 v1.0.0+23 테스트

### 2025-11-07 (이전) - Firebase Swift 컴파일 에러 발견

**서버 체크 (check 명령어)**:
- 질문: "우선 지금 마지막 에러가 뭐엿지?"

**마지막 에러 상황**:

✅ **iOS Release 빌드 성공** (b3072c):
```
✓ Built build/ios/iphoneos/Runner.app (16.0MB)
완료 시간: 169.7초
```

❌ **Debug 빌드들 실패** - Firebase Swift 컴파일 에러:
```
FirebaseCoreInternal/FIRAllocatedUnfairLock.swift:26:37
error: cannot find type 'sending' in scope
public init(initialState: sending State)

HeartbeatsPayload.swift:20:3
error: Access level on imports require '-enable-experimental-feature AccessLevelOnImport'
internal import GoogleUtilities
```

**원인 분석**:
- `sending` 키워드는 Swift 6.0 동시성 기능
- 현재 Xcode/Swift 버전이 지원하지 않음
- FirebaseCoreInternal이 최신 Swift 문법 사용
- Release 빌드는 성공했지만 Debug 빌드는 실패

**영향받는 빌드**:
- macOS Flutter run ❌
- iOS Debug build ❌
- Xcode simulator build ❌
- iOS Release build ✅ (성공!)

### 2025-11-07 (이전)
- 서버 업데이트 확인 (http://121.155.14.128/d.txt)
- 메시지: "우선 1107.md에 저장하고 check 부분 기억하고 git 아이디 토큰 기억꼭 해"
- ✅ check 명령어 기능 확인
- ✅ Git 토큰 정보 확인

### 2025-11-07 00:00 (새벽)
- v1.0.0+22 TestFlight 테스트 결과 확인
- Firebase가 원인이 아님 확인
- 다음 조사 대상: flutter_inappwebview
- 1107.md 문서 생성

---

**작성일**: 2025년 11월 7일
**작성자**: Claude Code
**프로젝트**: Sefra Flutter iOS App
